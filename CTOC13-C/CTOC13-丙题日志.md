# CTOC13-丙题日志

## 2024.10.7——10.8

### 计划：

1. 完成J2Lambert求解器，验证26gap填补程序的脉冲大小 - 完成

   a. 打靶函数，Lambert初值

   b. 求解器测试

2. 观察ATK目标分布

## 2024.10.9

### 计划：

完成Lambert版本的树

## 2024.10.15

经过测试填gap的方法对脉冲要求太高，可行度不够，于是想到重新搜索，需要重新改写启发函数

## 2024.10.16

与师兄讨论，发现目前的尝试过于混乱，在新的讨论模式上达成一致：

1. 一周讨论一次，定在每周日晚上，中间有特殊需求额外加讨论
2. 每次讨论前15分钟列一个讨论的大纲
3. 不管遇到什么情况，尝试必须围绕主线，对主线没有帮助的尝试不要做

### 生成了新策略：完全重新搜索

启发函数：

1. 可行性的保证：如果发现有目标点已扩展的节点最大重访时间已经超过指定时间，TNC立即停止扩展
2. 按照时间顺序进行扩展，还是用Lambert打靶，最大脉冲单次不超过1km/s，打靶中需要优化打靶的时间和Lambert打靶的高度
3. 停止的标准：所有的目标都完成了重访（最终希望要的结果）
4. 优先扩展：必须立刻看，否则任务将无法完成的点
5. 优化指标：脉冲

验证：先用8颗星地面全覆盖的构型做初值验证，搜索的分数应该不低于80

## 2024.10.19-2024.10.20

写好了完全重新搜索的程序，目前可以判断每次打靶中间是否还看到了其他的目标，最终生成每个TNC对应的真实时刻表

之前一直看不到ship，这次实测可以看到了，可能是没有专门对ship打靶的，但是沿途可以看到。在优先扩展的时候有可能每次需要考虑扩展的都是ship，这个问题需要解决，主要是时间的扰动问题，$t_f$的获取还需要再重新考虑。

## 2024.10.20

简单验证了一下8颗星80分的构型，小规模状态下，如果不设置扩展的优先级，很难扩展到底。

时间太短的观测只能通过扩展沿途的时刻表来判断是否可实现，经过ATK初步验证，以第一颗星为例，第一个观测到的应该是12号目标，时间在4620s左右，直接打靶很难打到，但是扩展时刻表的时候会扩展到，因为脉冲优化的缘故，实际上搜索过程也会尽量沿着原轨迹的趋势进行

怎么优先扩展比较紧急的点现在还在思考：

>应该在哪个函数里指定优先扩展？
>
>怎么给出优先扩展的规则：
>
>1. 规则基于当前TNC已有的时刻表
>2. 顺着problems_找节点，看每个节点对应的终末时刻$t_f$，和已经扩展好的时刻表对比

## 2024.10.21讨论

### 讨论大纲：

遇到的硬件问题：晚上断电，几个小时搜索跑不完，现在将任务分开，宿舍的台式机编程+测试，工位的电脑加大规模跑完整的搜索。

1. 进度：更新了所有星带机动的树搜索程序，目前已有的功能如下：

>a. 每次扩展会把打靶途中所有可见的目标都更新；
>
>b. 新增了可见性时刻表visibile_timelist，每次扩展TNC时，visited和visible_timelist一起更新
>
>c. 当某个目标最大重访时间满足要求时，visited置1，该目标后续不再专门打靶观测

截至讨论之前还没有的功能：

>优先扩展紧急的节点

结果：预计晚上上工位电脑算完整版

初步测试在ATK上测试了Sat1的第一次扩展，时间是能对上的，但是第二颗星扩不下去。

初步推测：测试的时候设置的迭代次数比较小（100次，实测迭代500次才能得到比较好的结果），是否还有底层逻辑的原因可以跑完完整版之后再分析

2. 目前需要解决的问题：节点扩展的优先级

梳理之后可以确定的规则：

>a. 确定紧急程度的基准：每个TNC更新的可见性时刻表
>
>b. 扩展的要求：必须扩展那些不扩展很可能就无法满足重访要求的点
>
>c. 扩展的节点能否覆盖到该节点：直接从时刻表获取覆盖时间

暂未确定的规则：

>a. 具体的紧急程度根据哪个时间来定？
>
>可能思路：当前TNC对应时刻表的最晚时间？节点的$t_f$？
>
>b. 如何实现“优先”的功能？
>
>需要考虑的问题：
>
>> 必须扩展的点可能不止一个；
>>
>> 必须扩展的点这颗星不一定能扩展，或者让其他星来扩展反而更好；
>>
>> 优先的处理方法：排序？有紧急点的情况下直接把不紧急的删去？

3. 下一步的方案：

(1) 提高扩展单节点的效率（扩展一个节点的运行时间，要具体的数值）

(2) 完成无机动8颗星的搜索验证：验证的分数+不同集束宽度的运行时间（也要具体的数值），反算8h之内搜索支持多大的集束宽度

(3) 初值选取

### 下周计划（2024.10.21-2024.10.27）：

(1) 修改打靶的程序：初值只给一次，nlopt迭代次数设为500次（10.21晚上完成）

> 测目标函数一次的运行时间；
>
> 测计算nlopt优化一次的总时间；
>
> 测集束宽度为1的总搜索时间

(2) 8颗星的搜索验证（10.22晚上跑完集束宽度1的结果）

>如果验证之后是正确的，10.24之前完成宽度为100，1000，10000的运行时间测试
>
>如果不正确则改成10.27跑完

(3) 初值选取

>如果(2)第一次验证通过，则10.24之前完成给初值的程序，10.27之前给一版可行解
>
>如果(2)第一次验证没通过，则集束宽度1的结果验证正确后3天内完成给初值的程序，5天内给一版可行解，最晚10.30之前给出可行解

## 2024.10.21

修改了打靶的程序，目前只能尽可能接近无机动的情况，但机动无法完全优化到0；

初值目前地面目标没问题，用张刚的论文给初值效果好，能保证一直可扩展，但是海上目标需要再想办法；

搜索效率提高了，集束宽度为1的程序可以在10分钟跑完，精确的时间晚上再用性能探查器：

>| 函数名称           | 总时间（VS性能探查器） | 调用次数（VS性能探查器） | 运行一次的时间（Relsease调试打断点打出来的） |
>| ------------------ | ---------------------- | ------------------------ | -------------------------------------------- |
>| Obs_shooting       | 72.91s                 | 40                       | 7.584s                                       |
>| Nlopt_main         | 72.82s                 | 16                       | 4.270s                                       |
>| Obj_funcv_shooting | 72.80s                 | 10749                    | 7ms（无惩罚时）1ms（惩罚时）                 |
>
>扩展一个TNC的时间$\approx$节点数*obs_shooting的时间

发现TNC扩展的早停机制不合理，应该在8颗星扩展后最末时刻相差较小的时候判断是否需要早停，否则一颗星扩展发现超出了，可能其他的星会把这个时刻补上，整体仍然是一个可行解。

## 2024.10.23

修改了早停机制，当所有树的终末时刻相差不到一小时的时候判断是否早停。目前8颗星无机动已经验过了，是80分，但是单次脉冲只能是比较接近0，不是完全为0，和给初值的方法有关。

### 目前的问题：

#### A. NLOPT的初值：

1. 地面目标目前采用的是张刚论文的方法，该方法保证了树能持续扩展，但对ship不好用，
2. J2 lambert给初值实测脉冲过大，很难优化到1km/s以下，且大脉冲情况下终末的速度不利于对下一个目标打靶（偏心率太大），最终会出现脉冲彻底失控的情况。

#### B. 运行速度

集束宽度为1的运行时间性能探测过多次，5-7s一个节点，重点探测的几个耗时函数的运行时间和10.21记录的表格一致

扩展一次的时间与扩展的节点数相关，扩展一次$t=N_{节点}*t_{单节点}$

#### C. 轨道根数的初值

需要问下师兄树里面怎么加多个根节点？

获取了一下师弟的xml文件，结合了当前8颗星构型的验证结果，目前发现比较好的构型应该是这样的：

>尽可能多的打擦边，不一定立刻就可见
>
>可见性反而不能太准确，机动不可能完全为0，要给机动留出余地调整可见时刻
>
>只看一圈的星下点轨迹就够了，机动次数多了星下点轨迹会有较大的偏离

## 2024.10.27 讨论

8棵树集束宽度1的运行时间已测出。

### 问题：

1. 扩展一个节点花费的时间还是过长，约为7s，讨论之后决定降低nlopt优化时积分的精度加快优化的速度，优化结束后再用高精度积分；
2. 树节点扩展非线性，经查发现是树节点的排序没改写，需要重写Sort函数；
3. 张刚论文的方法出现时间较短的点打靶打不到的情况，需要将single_imp中筛选最小脉冲的功能去掉；
4. 根节点初值的生成：在实际根节点上方增加虚拟根节点扩展多个初值

### 下周的计划（2024.10.28-2024.11.3）：

1. 按照讨论的问题改完树程序（暂不考虑根节点初值），测试100,1000,10000的运行时间，10.31完成
2. 增加根节点初值的遍历，11.3完成程序
3. 11.3晚上做第一次大规模的搜索

## 2024.11.3讨论

### 当前进度：

除了根节点搜索之外都已经修改完成，用原来的初值做了宽度100,1000,10000的搜索。主要修改点：

1. ship的观测：在张刚论文方法的基础上增加了角速度加成，和地面目标观测效果一致；
2. TNC排序函数的修改：先比较两个TNC当前的总观测次数，次数相同时比较脉冲大小；
3. 早停机制发现退出方式不合理，已经修好了；
4. nlopt目标函数使用J2线性模型加速，目前运行时间情况如下：

| 函数名                          | 函数体运行时间 |
| ------------------------------- | -------------- |
| Obs_shooting（扩展一个节点）    | 15ms           |
| Obj_func（nlopt对应的目标函数） | 10us           |

| 集束宽度W | 总运行时间 |
| --------- | ---------- |
| 100       | 34s        |
| 1000      | 377s       |
| 10000     | 3522s      |

5. 初值搜索（还在编程中）：

每棵树设置一个虚拟根节点，扩展实际根节点：

>SMA：7200km-7350km，step = 50km
>
>ECC：0  （，0.001）
>
>INC：120°-160°，step = 10°
>
>RAAN：0-360°，step = 60°
>
>AP：0-360°，step = 60° （0）
>
>TA：0-360°，step = 60°

每棵树的备选实际根节点数=$4\times 2\times 5\times 7\times 7\times 7 = 13720$

## 2024.11.7

### 打靶函数漏看的问题

目前发现了有高度问题，优化之后可以解决一部分，但同时发现扩展点的速度变慢了。

基础函数：

| 函数名       | 函数运行时间 |
| ------------ | ------------ |
| Obj_func     | 0.9us        |
| obs_shooting | 14ms         |

总运行时间及对应的扩展层数：

| 集束宽度W | 停止的扩展层数 | 总时间   | 平均一层的时间 |
| --------- | -------------- | -------- | -------------- |
| 10        | 36             | 41.5898s | 1.155s         |
| 100       | 42             | 333.187s | 7.933s         |
| 1000      | 36             | 3187.75s | 88.549s        |

可行解至少要扩展176层（最低访问次数8*20+16），这样算如果是一个晚上跑完且要求扩展到底的话，16核能接受的集束宽度只有3000左右。

<font color=red>比较危险的问题：</font>

1. 找到了一个解不出来的情况，算例在main.cpp里。

   算例是2号&3号目标，有解，ATK上显示在1000s和82000s左右都可见

   但解出来的结果不管圈数设为多少，得到的总是82000s的那个解。同时发现single_imp能够成功区分的时间差必须在1000s以上，间隔1000s以下的连续观测无法拆成两次扩展；

2. 距离太近，大概率同时观测的目标（比如目标2&3，看到2必看到3）单颗星没法用single_imp同时扩展，因此加入可见列表还是有必要的，但扩展的范围只放宽到打靶时间的前后1分钟内；
3. NLOPT一直就没有收敛过，查了flag，出现的问题集中在精度达不到（ftol或者xtol达不到）、次数超过限制（maxeval reached），可能是指标设计的不好，不平滑。

### 初值

试了一下网格密度不够，计划今晚开始进行单颗星的动力学分析。

暂时用圆轨道，初步判定真近点角可以机动调相解决，重点分析半长轴、倾角、升交点赤经。

- 半长轴：之前思维定式认为高度比较高观测范围就大，但其实只是放宽了经纬度差的限制，周期上不一定占据优势，机动可以精确过点的话，或许可以尝试高度低但是速度快的轨道；
- 倾角：决定了可覆盖的范围，也决定了星下点轨迹偏移的周期，主要是要找到能覆盖不同纬度区的最低倾角；
- 升交点赤经：直接决定了哪些点可能被覆盖，重点筛选看的点多的

机动能调整的经纬度有限，分析时将敏感器的视场角扩大到25度，20度以内的给标记，大于20度但在阈值范围内的潜力点也做不同的标记。

## 2024.11.8

生成了一个初步的根数-观测数的数据库，发现了IO瓶颈，但不影响初步的分析。

视场角放宽到25度，选出的点20度不一定能观测，但是通过机动大概率能看到。

今日计划：

1. 先用小数据库做一些初步的分析。绘制一下图表看看能不能归纳出系统的规律。

2. 晚上下工前加一个专门针对ship的数据库。

3. 解决树程序基建的问题（single_imp的无解问题，无法同时观测的问题，NLOPT不收敛的问题），目前可确定树本身的结构没有问题，问题都出在打靶上。目前计划先做初值分析，这些问题和分析结果一起并入周日的讨论
4. 目前正在跑一个大数据库，预计晚上十点之前跑完。如果跑完就用大数据库分析，没跑完就用小数据库先做。 - 后续：大数据库已经跑完，尝试本地用python分析一波

## 2024.11.9

### 观测总量的大数据库分析

总观测量的大数据库已经跑出来了，做了一下总观测量-SMA&INC&RAAN的关系分析。

<font color=red>注意：数据库的可观测角已经放宽到了25°，也就是说不一定符合题目的观测，但是通过机动有希望看到。如果仍然观测不到，可以直接筛掉！</font>

p.s. 这个次数计算的是可见性时刻的总次数，实际观测次数会比这个少一些（覆盖时间较长的会有重复统计）

目前画出的图如下：

![total](/Users/polly/Desktop/ctoc13-target-revisit/CTOC13-C/figs/total.png)

从图中可以看出总观测能力跟根数的关系是有一些规律的：

- SMA：和轨道高度正相关，这一点比较符合预期，因为总观测量对星下点轨迹可覆盖的范围要求更高，轨道高度越高视场范围越大。
  - 目前来看论总次数最佳的观测 SMA应该在<font color=red>7150km</font>以上。

<font color=yellow>值得注意的是，这并不意味着低轨道就没有意义，因为低轨道的劣势是覆盖范围小，精度要求高，总量必然不占优势。但是低轨周期短，角速度快，针对特定的目标设计能有特殊的优势（这一点会在ship的结果里分析）。</font>

- INC：角度呈现出明显的规律，无论什么轨道高度，都是在弧度<font color=lightgreen>0.7-1.3</font>（角度<font color=red>40.1-74.5</font>）以及<font color=lightgreen>2.2-2.8</font>（角度<font color=red>126.1-160.4</font>）的范围看得的目标比较多。

  > 1. 关于顺行和逆行：我们之前认为应该尽量选择逆行的策略是片面的，只要角度合适，顺行也可以取得和逆行一样好的结果。这一结果也是合理的，因为地球自转角速度很慢，这一点角速度加成不一定能有很大助力。结合之前师弟提供的顺行满分的结果，目前认为对于地面目标可以考虑顺行，这一点可以结合后面ship的分析一起筛选。
  >
  > 2. 顺逆行的最佳角度范围不互补：这一点可能是角速度加成带来的影响，导致逆行的较优轨道朝着低倾角方向偏移了。
  >
  >    在ATK上取了两个互补的倾角分析了一下（87.3°和92.7°），发现星下点轨迹在测地线网格上的经度间隔有明显的差别：
  >
  >    | INC（deg） | 相邻两条星下点轨迹间隔（deg） |
  >    | ---------- | ----------------------------- |
  >    | 87.3       | 27.5                          |
  >    | 92.7       | 22.5                          |
  >
  >    这可能导致同样的纬度覆盖范围下，逆行轨道有更大的经度覆盖优势。

- RAAN：目前没看出有特别强的规律，但是能隐约看出一点类似于鱼骨的结构。RAAN的特殊之处在于不会对特定值提出要求，只要保证间隔满足，观测的能力就是基本一致的。在INC观测结果的临界处，鱼骨结构大约有14个间隔，对应RAAN的间隔约在25°左右。结合INC部分计算的表格，这个间隔也是合理的。当然，明显的差异还是要在观测较好的SMA和INC基础上才能看出。

### 海上目标的观测分析

ship的观测量数据库也已经完成，进行了一下分析，绘出来的图如下图所示：

![ship](/Users/polly/Desktop/ctoc13-target-revisit/CTOC13-C/figs/ship.png)

为了更清楚4次以上的详情，绘制了上限到8次的图：

![ship-max8](/Users/polly/Desktop/ctoc13-target-revisit/CTOC13-C/figs/ship-max8.png)

目前总结出来的规律：

- SMA：近似正相关，但不能完全不考虑低轨情况，也就是不一定都要到900km以上。
  - 低倾角条件下高轨和低轨都能观测很多次ship，但是太低轨也可以不考虑，因为地面几乎没法看
  - 低轨在倾角适中的时候也可以达到和高轨一样的观测效果（三个轨道高度都出现了规律的鱼骨结构，并且在中倾角位置有红色区域）
- INC：脱离低轨范围之后基本上和倾角无关了（除了低轨情况出现了例外）
- RAAN：对于ship比INC重要，仍然是鱼骨结构，14个空隙

### 综合两个数据库统计结果得到的一些结论

我们当前的树搜索一个重要特征是地面与海上兼顾，也就是<font color=red>不需要针对海上目标布置特殊的星</font>，而且为了防止浪费，<font color=red>最好不要专门布置根数太特殊的星</font>。同时，总观测次数和ship的观测规律也有一定的重合，初步断定可以不用师弟们之前那种专门设置低轨看ship的策略。关于根数的设置也有一些细节的结论：

- SMA：可以判定应该尽量选7000km以上的轨道。
  - 7000km以下的虽然也有一些看ship有利的情况，但是对地面贡献太少，属于是“专门看ship”的，浪费星数；
  - 专门看ship的情况需要INC和RAAN设计比较精确，鉴于single_imp给初值时间会差一点，覆盖面积太小也不利于nlopt做优化
- INC：顺行和逆行都能取得很好的观测结果，完全可以考虑都用
  - 针对不同的高度，顺逆行哪个更适合可以得到不同的结论，比如对于看ship，7020km的轨道顺行更适合，7200km的轨道就是逆行更适合，因此选哪个还是要看我们选的SMA，应该在选好SMA之后专门分析最适合这个SMA的INC
  - INC需要综合考虑地面总观测还有ship的适用范围。选取同时符合两个条件的倾角
  - 后续还要考虑特殊的地面点，比如非常高纬度的4号和16号，因此选取的INC至少有一半要达到57度以上
- RAAN：已经可以确定比较合适的角度范围了，且可以初步按照14个间隔的宽度（25度左右）寻找比较适合的构型
  - 加机动之后回归构型会被破坏，所以只需要在这14个范围当中挑较好的赤经就可以了，可以考虑突破一颗主星跟3个副星的设计
  - 综合之前的经验，有些纬度不算很高但就是看不到的点（记得是12号？待确认），还有一些不管怎么设计都很容易看到的点（19号），需要研究一下手搓时出现这些现象的原因，极有可能和手搓时选择的赤经集中在了某个范围有关

## 2024.11.10 讨论大纲

### 当前进度：

#### Part 1 树程序：搜索的基本功能可以确定没有问题，问题都集中在打靶观测

- Single_imp：高度问题和无解问题同时存在，高度问题已解决，无解问题算例如下：

  >目标：2号
  >
  >程序：
  >
  >![Screenshot 2024-11-10 at 15.06.48](/Users/polly/Library/Application Support/typora-user-images/Screenshot 2024-11-10 at 15.06.48.png)
  >
  >预期运行结果：NR=1时，应该出现一个1020s左右的结果，NR>10时应该出现一个80000s左右的结果
  >
  >实际结果：不管NR为多少，解出来的都是对应80000s的结果，NR较小时解出来的脉冲大，NR较大时解出来的脉冲小，tf略有差别但很小
  >
  >NR=1，branch=1：（branch=0无解）
  >
  >![Screenshot 2024-11-10 at 15.11.22](/Users/polly/Library/Application Support/typora-user-images/Screenshot 2024-11-10 at 15.11.22.png)
  >
  >NR=10，branch=1：（branch=0无解）
  >
  >![Screenshot 2024-11-10 at 15.12.13](/Users/polly/Library/Application Support/typora-user-images/Screenshot 2024-11-10 at 15.12.13.png)
  >
  >原本以为是过点不够精确，查了一下ATK的结果，星下点轨迹几乎可以认定是精确过点：（当前时间戳对应2035-09-26 12:18:57）
  >
  >![Screenshot 2024-11-10 at 15.15.12](/Users/polly/Library/Application Support/typora-user-images/Screenshot 2024-11-10 at 15.15.12.png)

检查了一下之前收割过的结果，相邻两次观测的时间差也没有低于半小时的。重读了论文的结果部分，表格里的结果都是至少8小时（因为只给了脉冲最小的结果），没法确认短时飞行的可解性。

我目前推测半小时，特别是20分钟以内的连续观测single_imp可能都解不出来，图中这种2和3几乎同时覆盖的更没法单独扩展，因此用师兄写的时刻表辅助扩展我觉得还是必要的，只是扩展的时间范围可以调小一些，比如t0之后30min内，tf之前30min内，把解不出来的这段时间盖住就可以。

- NLOPT：查看了flag，发现优化从来就没收敛过，即使是成功扩展的情况也是如此。
  - flag的信息集中在MaxEval Reached、Xtol / Ftol Reached两种，maxstep低的时候flag基本上都对应前者，增加了maxstep之后就对应后者。
  - 打断点并在ATK上确认了一下，只要single_imp有解，nlopt就会朝着正确的方向优化，因此我认为初值问题不大。

#### Part 2 初值分析：临时改了策略，先跑了数据库进行大规模的根数分析

- 总观测量数据库

  > 规模：RAAN * INC * SMA = 500 * 200 * 100
  >
  > 计算目标：总观测次数$N_{total}$，覆盖时间超过1min的没做去重

