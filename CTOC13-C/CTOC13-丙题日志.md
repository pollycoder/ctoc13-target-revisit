# CTOC13-丙题日志

## 2024.10.7——10.8

### 计划：

1. 完成J2Lambert求解器，验证26gap填补程序的脉冲大小 - 完成

   a. 打靶函数，Lambert初值

   b. 求解器测试

2. 观察ATK目标分布

## 2024.10.9

### 计划：

完成Lambert版本的树

## 2024.10.15

经过测试填gap的方法对脉冲要求太高，可行度不够，于是想到重新搜索，需要重新改写启发函数

## 2024.10.16

与师兄讨论，发现目前的尝试过于混乱，在新的讨论模式上达成一致：

1. 一周讨论一次，定在每周日晚上，中间有特殊需求额外加讨论
2. 每次讨论前15分钟列一个讨论的大纲
3. 不管遇到什么情况，尝试必须围绕主线，对主线没有帮助的尝试不要做

### 生成了新策略：完全重新搜索

启发函数：

1. 可行性的保证：如果发现有目标点已扩展的节点最大重访时间已经超过指定时间，TNC立即停止扩展
2. 按照时间顺序进行扩展，还是用Lambert打靶，最大脉冲单次不超过1km/s，打靶中需要优化打靶的时间和Lambert打靶的高度
3. 停止的标准：所有的目标都完成了重访（最终希望要的结果）
4. 优先扩展：必须立刻看，否则任务将无法完成的点
5. 优化指标：脉冲

验证：先用8颗星地面全覆盖的构型做初值验证，搜索的分数应该不低于80

## 2024.10.19-2024.10.20

写好了完全重新搜索的程序，目前可以判断每次打靶中间是否还看到了其他的目标，最终生成每个TNC对应的真实时刻表

之前一直看不到ship，这次实测可以看到了，可能是没有专门对ship打靶的，但是沿途可以看到。在优先扩展的时候有可能每次需要考虑扩展的都是ship，这个问题需要解决，主要是时间的扰动问题，$t_f$的获取还需要再重新考虑。

## 2024.10.20

简单验证了一下8颗星80分的构型，小规模状态下，如果不设置扩展的优先级，很难扩展到底。

时间太短的观测只能通过扩展沿途的时刻表来判断是否可实现，经过ATK初步验证，以第一颗星为例，第一个观测到的应该是12号目标，时间在4620s左右，直接打靶很难打到，但是扩展时刻表的时候会扩展到，因为脉冲优化的缘故，实际上搜索过程也会尽量沿着原轨迹的趋势进行

怎么优先扩展比较紧急的点现在还在思考：

>应该在哪个函数里指定优先扩展？
>
>怎么给出优先扩展的规则：
>
>1. 规则基于当前TNC已有的时刻表
>2. 顺着problems_找节点，看每个节点对应的终末时刻$t_f$，和已经扩展好的时刻表对比

## 2024.10.21讨论

### 讨论大纲：

遇到的硬件问题：晚上断电，几个小时搜索跑不完，现在将任务分开，宿舍的台式机编程+测试，工位的电脑加大规模跑完整的搜索。

1. 进度：更新了所有星带机动的树搜索程序，目前已有的功能如下：

>a. 每次扩展会把打靶途中所有可见的目标都更新；
>
>b. 新增了可见性时刻表visibile_timelist，每次扩展TNC时，visited和visible_timelist一起更新
>
>c. 当某个目标最大重访时间满足要求时，visited置1，该目标后续不再专门打靶观测

截至讨论之前还没有的功能：

>优先扩展紧急的节点

结果：预计晚上上工位电脑算完整版

初步测试在ATK上测试了Sat1的第一次扩展，时间是能对上的，但是第二颗星扩不下去。

初步推测：测试的时候设置的迭代次数比较小（100次，实测迭代500次才能得到比较好的结果），是否还有底层逻辑的原因可以跑完完整版之后再分析

2. 目前需要解决的问题：节点扩展的优先级

梳理之后可以确定的规则：

>a. 确定紧急程度的基准：每个TNC更新的可见性时刻表
>
>b. 扩展的要求：必须扩展那些不扩展很可能就无法满足重访要求的点
>
>c. 扩展的节点能否覆盖到该节点：直接从时刻表获取覆盖时间

暂未确定的规则：

>a. 具体的紧急程度根据哪个时间来定？
>
>可能思路：当前TNC对应时刻表的最晚时间？节点的$t_f$？
>
>b. 如何实现“优先”的功能？
>
>需要考虑的问题：
>
>> 必须扩展的点可能不止一个；
>>
>> 必须扩展的点这颗星不一定能扩展，或者让其他星来扩展反而更好；
>>
>> 优先的处理方法：排序？有紧急点的情况下直接把不紧急的删去？

3. 下一步的方案：

(1) 提高扩展单节点的效率（扩展一个节点的运行时间，要具体的数值）

(2) 完成无机动8颗星的搜索验证：验证的分数+不同集束宽度的运行时间（也要具体的数值），反算8h之内搜索支持多大的集束宽度

(3) 初值选取

### 下周计划（2024.10.21-2024.10.27）：

(1) 修改打靶的程序：初值只给一次，nlopt迭代次数设为500次（10.21晚上完成）

> 测目标函数一次的运行时间；
>
> 测计算nlopt优化一次的总时间；
>
> 测集束宽度为1的总搜索时间

(2) 8颗星的搜索验证（10.22晚上跑完集束宽度1的结果）

>如果验证之后是正确的，10.24之前完成宽度为100，1000，10000的运行时间测试
>
>如果不正确则改成10.27跑完

(3) 初值选取

>如果(2)第一次验证通过，则10.24之前完成给初值的程序，10.27之前给一版可行解
>
>如果(2)第一次验证没通过，则集束宽度1的结果验证正确后3天内完成给初值的程序，5天内给一版可行解，最晚10.30之前给出可行解

## 2024.10.21

修改了打靶的程序，目前只能尽可能接近无机动的情况，但机动无法完全优化到0；

初值目前地面目标没问题，用张刚的论文给初值效果好，能保证一直可扩展，但是海上目标需要再想办法；

搜索效率提高了，集束宽度为1的程序可以在10分钟跑完，精确的时间晚上再用性能探查器：

>| 函数名称           | 总时间（VS性能探查器） | 调用次数（VS性能探查器） | 运行一次的时间（Relsease调试打断点打出来的） |
>| ------------------ | ---------------------- | ------------------------ | -------------------------------------------- |
>| Obs_shooting       | 72.91s                 | 40                       | 7.584s                                       |
>| Nlopt_main         | 72.82s                 | 16                       | 4.270s                                       |
>| Obj_funcv_shooting | 72.80s                 | 10749                    | 7ms（无惩罚时）1ms（惩罚时）                 |
>
>扩展一个TNC的时间$\approx$节点数*obs_shooting的时间

发现TNC扩展的早停机制不合理，应该在8颗星扩展后最末时刻相差较小的时候判断是否需要早停，否则一颗星扩展发现超出了，可能其他的星会把这个时刻补上，整体仍然是一个可行解。

## 2024.10.23

修改了早停机制，当所有树的终末时刻相差不到一小时的时候判断是否早停。目前8颗星无机动已经验过了，是80分，但是单次脉冲只能是比较接近0，不是完全为0，和给初值的方法有关。

### 目前的问题：

#### A. NLOPT的初值：

1. 地面目标目前采用的是张刚论文的方法，该方法保证了树能持续扩展，但对ship不好用，
2. J2 lambert给初值实测脉冲过大，很难优化到1km/s以下，且大脉冲情况下终末的速度不利于对下一个目标打靶（偏心率太大），最终会出现脉冲彻底失控的情况。

#### B. 运行速度

集束宽度为1的运行时间性能探测过多次，5-7s一个节点，重点探测的几个耗时函数的运行时间和10.21记录的表格一致

扩展一次的时间与扩展的节点数相关，扩展一次$t=N_{节点}*t_{单节点}$

#### C. 轨道根数的初值

需要问下师兄树里面怎么加多个根节点？

获取了一下师弟的xml文件，结合了当前8颗星构型的验证结果，目前发现比较好的构型应该是这样的：

>尽可能多的打擦边，不一定立刻就可见
>
>可见性反而不能太准确，机动不可能完全为0，要给机动留出余地调整可见时刻
>
>只看一圈的星下点轨迹就够了，机动次数多了星下点轨迹会有较大的偏离

## 2024.10.27 讨论

8棵树集束宽度1的运行时间已测出。

### 问题：

1. 扩展一个节点花费的时间还是过长，约为7s，讨论之后决定降低nlopt优化时积分的精度加快优化的速度，优化结束后再用高精度积分；
2. 树节点扩展非线性，经查发现是树节点的排序没改写，需要重写Sort函数；
3. 张刚论文的方法出现时间较短的点打靶打不到的情况，需要将single_imp中筛选最小脉冲的功能去掉；
4. 根节点初值的生成：在实际根节点上方增加虚拟根节点扩展多个初值

### 下周的计划（2024.10.28-2024.11.3）：

1. 按照讨论的问题改完树程序（暂不考虑根节点初值），测试100,1000,10000的运行时间，10.31完成
2. 增加根节点初值的遍历，11.3完成程序
3. 11.3晚上做第一次大规模的搜索

## 2024.11.3讨论

### 当前进度：

除了根节点搜索之外都已经修改完成，用原来的初值做了宽度100,1000,10000的搜索。主要修改点：

1. ship的观测：在张刚论文方法的基础上增加了角速度加成，和地面目标观测效果一致；
2. TNC排序函数的修改：先比较两个TNC当前的总观测次数，次数相同时比较脉冲大小；
3. 早停机制发现退出方式不合理，已经修好了；
4. nlopt目标函数使用J2线性模型加速，目前运行时间情况如下：

| 函数名                          | 函数体运行时间 |
| ------------------------------- | -------------- |
| Obs_shooting（扩展一个节点）    | 15ms           |
| Obj_func（nlopt对应的目标函数） | 10us           |

| 集束宽度W | 总运行时间 |
| --------- | ---------- |
| 100       | 34s        |
| 1000      | 377s       |
| 10000     | 3522s      |

5. 初值搜索（还在编程中）：

每棵树设置一个虚拟根节点，扩展实际根节点：

>SMA：7200km-7350km，step = 50km
>
>ECC：0  （，0.001）
>
>INC：120°-160°，step = 10°
>
>RAAN：0-360°，step = 60°
>
>AP：0-360°，step = 60° （0）
>
>TA：0-360°，step = 60°

每棵树的备选实际根节点数=$4\times 2\times 5\times 7\times 7\times 7 = 13720$

## 2024.11.7

### 打靶函数漏看的问题

目前发现了有高度问题，优化之后可以解决一部分，但同时发现扩展点的速度变慢了。

基础函数：

| 函数名       | 函数运行时间 |
| ------------ | ------------ |
| Obj_func     | 0.9us        |
| obs_shooting | 14ms         |

总运行时间及对应的扩展层数：

| 集束宽度W | 停止的扩展层数 | 总时间   | 平均一层的时间 |
| --------- | -------------- | -------- | -------------- |
| 10        | 36             | 41.5898s | 1.155s         |
| 100       | 42             | 333.187s | 7.933s         |
| 1000      | 36             | 3187.75s | 88.549s        |

可行解至少要扩展176层（最低访问次数8*20+16），这样算如果是一个晚上跑完且要求扩展到底的话，16核能接受的集束宽度只有3000左右。

<font color=red>比较危险的问题：</font>

1. 找到了一个解不出来的情况，算例在main.cpp里。

   算例是2号&3号目标，有解，ATK上显示在1000s和82000s左右都可见

   但解出来的结果不管圈数设为多少，得到的总是82000s的那个解。同时发现single_imp能够成功区分的时间差必须在1000s以上，间隔1000s以下的连续观测无法拆成两次扩展；

2. 距离太近，大概率同时观测的目标（比如目标2&3，看到2必看到3）单颗星没法用single_imp同时扩展，因此加入可见列表还是有必要的，但扩展的范围只放宽到打靶时间的前后1分钟内；
3. NLOPT一直就没有收敛过，查了flag，出现的问题集中在精度达不到（ftol或者xtol达不到）、次数超过限制（maxeval reached），可能是指标设计的不好，不平滑。

### 初值

试了一下网格密度不够，计划今晚开始进行单颗星的动力学分析。

暂时用圆轨道，初步判定真近点角可以机动调相解决，重点分析半长轴、倾角、升交点赤经。

- 半长轴：之前思维定式认为高度比较高观测范围就大，但其实只是放宽了经纬度差的限制，周期上不一定占据优势，机动可以精确过点的话，或许可以尝试高度低但是速度快的轨道；
- 倾角：决定了可覆盖的范围，也决定了星下点轨迹偏移的周期，主要是要找到能覆盖不同纬度区的最低倾角；
- 升交点赤经：直接决定了哪些点可能被覆盖，重点筛选看的点多的

机动能调整的经纬度有限，分析时将敏感器的视场角扩大到25度，20度以内的给标记，大于20度但在阈值范围内的潜力点也做不同的标记。

## 2024.11.8

生成了一个初步的根数-观测数的数据库，发现了IO瓶颈，但不影响初步的分析。

视场角放宽到25度，选出的点20度不一定能观测，但是通过机动大概率能看到。

今日计划：

1. 先用小数据库做一些初步的分析。绘制一下图表看看能不能归纳出系统的规律。

2. 晚上下工前加一个专门针对ship的数据库。

3. 解决树程序基建的问题（single_imp的无解问题，无法同时观测的问题，NLOPT不收敛的问题），目前可确定树本身的结构没有问题，问题都出在打靶上。目前计划先做初值分析，这些问题和分析结果一起并入周日的讨论
4. 目前正在跑一个大数据库，预计晚上十点之前跑完。如果跑完就用大数据库分析，没跑完就用小数据库先做。 - 后续：大数据库已经跑完，尝试本地用python分析一波

## 2024.11.9

### 观测总量的大数据库分析

总观测量的大数据库已经跑出来了，做了一下总观测量-SMA&INC&RAAN的关系分析。

<font color=red>注意：数据库的可观测角已经放宽到了25°，也就是说不一定符合题目的观测，但是通过机动有希望看到。如果仍然观测不到，可以直接筛掉！</font>

p.s. 这个次数计算的是可见性时刻的总次数，实际观测次数会比这个少一些（覆盖时间较长的会有重复统计）

目前画出的图如下：

![total](/Users/polly/Desktop/ctoc13-target-revisit/CTOC13-C/figs/total.png)

从图中可以看出总观测能力跟根数的关系是有一些规律的：

- SMA：和轨道高度正相关，这一点比较符合预期，因为总观测量对星下点轨迹可覆盖的范围要求更高，轨道高度越高视场范围越大。
  - 目前来看论总次数最佳的观测 SMA应该在<font color=red>7150km</font>以上。

<font color=yellow>值得注意的是，这并不意味着低轨道就没有意义，因为低轨道的劣势是覆盖范围小，精度要求高，总量必然不占优势。但是低轨周期短，角速度快，针对特定的目标设计能有特殊的优势（这一点会在ship的结果里分析）。</font>

- INC：角度呈现出明显的规律，无论什么轨道高度，都是在40°-75°，130°-163°的范围看得的目标比较多。

  > 1. 关于顺行和逆行：我们之前认为应该尽量选择逆行的策略是片面的，只要角度合适，顺行也可以取得和逆行一样好的结果。这一结果也是合理的，因为地球自转角速度很慢，这一点角速度加成不一定能有很大助力。结合之前师弟提供的顺行满分的结果，目前认为对于地面目标可以考虑顺行，这一点可以结合后面ship的分析一起筛选。
  >
  > 2. 顺逆行的最佳角度范围不互补：这一点可能是角速度加成带来的影响，导致逆行的较优轨道朝着低倾角方向偏移了。
  >
  >    在ATK上取了两个互补的倾角分析了一下（87.3°和92.7°），发现星下点轨迹在测地线网格上的经度间隔有明显的差别：
  >
  >    | INC（deg） | 相邻两条星下点轨迹间隔（deg） |
  >    | ---------- | ----------------------------- |
  >    | 87.3       | 27.5                          |
  >    | 92.7       | 22.5                          |
  >
  >    这可能导致同样的纬度覆盖范围下，逆行轨道有更大的经度覆盖优势。

- RAAN：目前没看出有特别强的规律，但是能隐约看出一点类似于鱼骨的结构。RAAN的特殊之处在于不会对特定值提出要求，只要保证间隔满足，观测的能力就是基本一致的。在INC观测结果的临界处，鱼骨结构大约有14个间隔，对应RAAN的间隔约在25°左右。结合INC部分计算的表格，这个间隔也是合理的。当然，明显的差异还是要在观测较好的SMA和INC基础上才能看出。

### 海上目标的观测分析

ship的观测量数据库也已经完成，进行了一下分析，绘出来的图如下图所示：

![ship](/Users/polly/Desktop/ctoc13-target-revisit/CTOC13-C/figs/ship.png)

为了更清楚4次以上的详情，绘制了上限到8次的图：

![ship-max8](/Users/polly/Desktop/ctoc13-target-revisit/CTOC13-C/figs/ship-max8.png)

目前总结出来的规律：

- SMA：近似正相关，但不能完全不考虑低轨情况，也就是不一定都要到900km以上。
  - 低倾角条件下高轨和低轨都能观测很多次ship，但是太低轨也可以不考虑，因为地面几乎没法看
  - 低轨在倾角适中的时候也可以达到和高轨一样的观测效果（三个轨道高度都出现了规律的鱼骨结构，并且在中倾角位置有红色区域）
- INC：脱离低轨范围之后基本上和倾角无关了（除了低轨情况出现了例外）
- RAAN：对于ship比INC重要，仍然是鱼骨结构，14个空隙

### 综合两个数据库统计结果得到的一些结论

我们当前的树搜索一个重要特征是地面与海上兼顾，也就是<font color=red>不需要针对海上目标布置特殊的星</font>，而且为了防止浪费，<font color=red>最好不要专门布置根数太特殊的星</font>。同时，总观测次数和ship的观测规律也有一定的重合，初步断定可以不用师弟们之前那种专门设置低轨看ship的策略。关于根数的设置也有一些细节的结论：

- SMA：可以判定应该尽量选7000km以上的轨道。
  - 7000km以下的虽然也有一些看ship有利的情况，但是对地面贡献太少，属于是“专门看ship”的，浪费星数；
  - 专门看ship的情况需要INC和RAAN设计比较精确，鉴于single_imp给初值时间会差一点，覆盖面积太小也不利于nlopt做优化
- INC：顺行和逆行都能取得很好的观测结果，完全可以考虑都用
  - 针对不同的高度，顺逆行哪个更适合可以得到不同的结论，比如对于看ship，7020km的轨道顺行更适合，7200km的轨道就是逆行更适合，因此选哪个还是要看我们选的SMA，应该在选好SMA之后专门分析最适合这个SMA的INC
  - INC需要综合考虑地面总观测还有ship的适用范围。选取同时符合两个条件的倾角
  - 后续还要考虑特殊的地面点，比如非常高纬度的4号和16号，因此选取的INC至少有一半要达到57度以上
- RAAN：已经可以确定比较合适的角度范围了，且可以初步按照14个间隔的宽度（25度左右）寻找比较适合的构型
  - 加机动之后回归构型会被破坏，所以只需要在这14个范围当中挑较好的赤经就可以了，可以考虑突破一颗主星跟3个副星的设计
  - 综合之前的经验，有些纬度不算很高但就是看不到的点（记得是12号？待确认），还有一些不管怎么设计都很容易看到的点（19号），需要研究一下手搓时出现这些现象的原因，极有可能和手搓时选择的赤经集中在了某个范围有关

## 2024.11.10 讨论

### 当前进度：

#### Part 1 树程序：搜索的基本功能可以确定没有问题，问题都集中在打靶观测

- Single_imp：高度问题和无解问题同时存在，高度问题已解决，无解问题算例如下：

  >目标：2号
  >
  >程序：
  >
  >![Screenshot 2024-11-10 at 15.06.48](/Users/polly/Library/Application Support/typora-user-images/Screenshot 2024-11-10 at 15.06.48.png)
  >
  >预期运行结果：NR=1时，应该出现一个1020s左右的结果，NR>10时应该出现一个80000s左右的结果
  >
  >实际结果：不管NR为多少，解出来的都是对应80000s的结果，NR较小时解出来的脉冲大，NR较大时解出来的脉冲小，tf略有差别但很小
  >
  >NR=1，branch=1：（branch=0无解）
  >
  >![Screenshot 2024-11-10 at 15.11.22](/Users/polly/Library/Application Support/typora-user-images/Screenshot 2024-11-10 at 15.11.22.png)
  >
  >NR=10，branch=1：（branch=0无解）
  >
  >![Screenshot 2024-11-10 at 15.12.13](/Users/polly/Library/Application Support/typora-user-images/Screenshot 2024-11-10 at 15.12.13.png)
  >
  >原本以为是过点不够精确，查了一下ATK的结果，星下点轨迹几乎可以认定是精确过点：（当前时间戳对应2035-09-26 12:18:57）
  >
  >![Screenshot 2024-11-10 at 15.15.12](/Users/polly/Library/Application Support/typora-user-images/Screenshot 2024-11-10 at 15.15.12.png)

检查了一下之前收割过的结果，相邻两次观测的时间差也没有低于半小时的。重读了论文的结果部分，表格里的结果都是至少8小时（因为只给了脉冲最小的结果），没法确认短时飞行的可解性。

我目前推测半小时，特别是20分钟以内的连续观测single_imp可能都解不出来，图中这种2和3几乎同时覆盖的更没法单独扩展，因此用师兄写的时刻表辅助扩展我觉得还是必要的，只是扩展的时间范围可以调小一些，比如t0之后30min内，tf之前30min内，把解不出来的这段时间盖住就可以。

- NLOPT：查看了flag，发现优化从来就没收敛过，即使是成功扩展的情况也是如此。

  - flag的信息集中在MaxEval Reached、Xtol / Ftol Reached两种，maxstep低的时候flag基本上都对应前者，增加了maxstep之后就对应后者。
  - 打断点并在ATK上确认了一下，只要single_imp有解，nlopt就会朝着正确的方向优化，因此我认为初值问题不大。

- 总扩展次数问题：完整扩展一次至少有176次（8 * 20 + 16 = 176），目前重新测试了运行时间如下：

  基础函数：

  | 函数名       | 函数运行时间 |
  | ------------ | ------------ |
  | Obj_func     | 0.9us        |
  | obs_shooting | 14ms         |

  总运行时间及对应的扩展层数：

  | 集束宽度W | 停止的扩展层数 | 总时间   | 平均一层的时间 |
  | --------- | -------------- | -------- | -------------- |
  | 10        | 36             | 41.5898s | 1.155s         |
  | 100       | 42             | 333.187s | 7.933s         |
  | 1000      | 36             | 3187.75s | 88.549s        |

  这样算如果是一个晚上跑完且要求扩展到底的话，16核能接受的集束宽度只有3000左右。
  
- 下一步的计划：

  - 解决掉single_imp和nlopt的问题
- 尝试进一步提速，争取在超算上规模能提升到W=100,000

#### Part 2 初值分析：临时改了策略，先跑了数据库进行大规模的根数分析

<font color=red>数据库都是圆轨道，真近点角为0</font>

- 总观测量数据库

  > 规模：RAAN * INC * SMA = 500 * 200 * 100
  >
  > 计算目标：总观测次数$N_{total}$，覆盖时间超过1min的没做去重

  - 绘制散点图如下：

	<img src="/Users/polly/Desktop/ctoc13-target-revisit/CTOC13-C/figs/total.png" alt="total" style="zoom:50%;" />

	- 分析：
	
	>- SMA：总观测量与轨道高度正相关，但不一定要900km以上，800km以上都可以考虑。
	>
	>- INC：
	>
	>顺行和逆行都可以获得较好的观测效果，顺行倾角集中在<font color=orange>45°-75°</font>，逆行倾角集中在<font color=orange>130°-160°</font>;
	>
	>两者范围不互补，可能是地球自转带来的影响：
	>
	>在ATK上取了两个互补的倾角分析了一下（87.3°和92.7°），星下点轨迹在测地线网格上的经度间隔有明显的差别：
	>
	>| INC（deg） | 相邻两条星下点轨迹间隔（deg） |
	>| ---------- | ----------------------------- |
	>| 87.3       | 27.5                          |
	>| 92.7       | 22.5                          |
	>
	>这可能导致同样的轨道面倾斜角，逆行轨道有更大的经度覆盖优势。
	>
	>RAAN：
	>
	>有类似鱼骨的结构，但不明显，ship的图会更明显
	>
	>鱼骨结构为14个间隔，间隔约为25°，和上面的星下点轨迹经度间隔吻合比较好


- ship观测量数据库

  >规模：RAAN * INC * SMA = 500 * 200 * 150
  >
  >计算目标：ship总观测次数，和总观测量数据库一样没有做过去重

  - 绘制的散点图如下，第一张最大值设为4次，第二张最大值设为8次：

	<img src="/Users/polly/Desktop/ctoc13-target-revisit/CTOC13-C/figs/ship.png" alt="ship" style="zoom: 100%;" />

	<img src="/Users/polly/Desktop/ctoc13-target-revisit/CTOC13-C/figs/ship-max8.png" alt="ship-max8" style="zoom: 100%;" />

	- 分析：

	>- SMA：整体上还是和高度正相关，但不绝对，要看搭配的INC和RAAN，仍然是800km以上都可以考虑
	>
	>- INC：仍然是顺行和逆行都有可能取到较好的观测结果，但是Ship的结论是顺行还是逆行要看选择的SMA
	>
	>- RAAN：鱼骨的结构非常明显，且和总观测量的范围基本吻合，综合总观测量的图，基本可以锁定较好的RAAN范围
	
- 下一步的分析：

  - 缩小根数范围，生成更精细的数据库
  - 针对SMA, INC, RAAN各自绘制二维图，获取准确的最佳范围
  
  - 特殊的地面点：纬度较高的点（4号、16号），纬度不高但是前期手搓很难观测的点（9号、12号，初步推测对应的RAAN与其他点不同）
  - 选一个根数初值进行树搜索，看一颗星加机动可以榨干到什么程度（single_imp修好之后）

## 2024.11.14 计划调整

### 初值分析：缩小倾角范围生成ship以及目标4（最高纬）数据库

初步决定舍弃低倾角初始根数：40°-60°，120°-140°，ship顺逆行均已完成，目标4逆行已经生成，在分析，可以得到明显的规律。

生成一个更小的ship数据库，所有ship观测数小于10的全部去除，这样留下的升交点赤经基本上可以确定都是比较好的了，跑完之后绘制一个精确的sma-inc-raan对应表，给后面挑选初值做参考。

准备在工位机上跑，预计8.3h结束。

### 优化策略：暂时舍掉树，改用根数序列搜索+单次大机动压榨

single_imp经检查发现了机理上的问题，问题记录在函数fail_example里。无论怎样都没法修好了，一时也没有较好的打靶策略，暂时舍弃，和师兄讨论之后再决定怎么给初值。

准备在ship数据库的基础上暴力搜索根数序列，寻找比较好的组合；目测小机动多次修正意义不大，因为提升nlopt优化次数之后会一直朝着无机动的方向优化，不如加少量大脉冲，以变赤经和半长轴为主。分为如下步骤：

1. 增加单颗星单次机动的优化程序，根数不动，优化脉冲时间和脉冲三分量，提升观测总量

   问题：指标太离散，需要有个平滑的处理，让优化朝着观测量更多的方向进行，目前暂时考虑用每个目标的平均重访时间，越小越好（单颗星不可能覆盖，越小意味着观测越平均，或者观测次数越多，都是比较有利于设计的），累加计分

2. 将单颗星改成多颗星，全机动，指标直接使用每个目标的重访时间，高于阈值分数基于满分平滑降低，低于阈值都是满分

目前单颗星单机动压榨已完成初版的优化程序，目测压榨有效果，可以增加可见目标的数量，同时缩减一些目标的重访；虽然有些重访会被破坏，但是是可以接受的。目前跑上了一颗星测测运行时间，看估算是否准确。

### 明日计划：在单颗星基础上改进成多颗星，写完多颗星压榨并测试正确性和运行时间

不保证一定出可行解，但是可以观察加机动的压榨程度；

后期考虑自学GA，搜索比较好的根数组合，先用8颗平均分布构型搞一版可行解

## 2024.11.15

单次大机动压榨初步认为非常有效，

可以看到机动压榨对于增加目标可见性效果非常显著，甚至可以让原本不可见的目标变得可见，这一点树搜索因为single_imp的问题，目前无法做到。

同时改了一版多颗星同时机动的程序，目前用了四颗星，从数据库里挑了一颗主星，跟了3个副星，升交点赤经差了90°。

无机动，平均重访时间14h：

机动后（很遗憾脉冲暂时没记录，晚上跑一版正式的解），平均重访时间9.9h：

![Screenshot 2024-11-15 at 14.49.13](/Users/polly/Desktop/ctoc13-target-revisit/CTOC13-C/figs/:Users:polly:Desktop:Screenshot 2024-11-15 at 14.49.13.png)

可以看到最长的间隔也只有18.6h了，原有的目标4没有丢失，因为重访间隔太小了，同时还增加了一些可见的目标和接近可见的目标（20,5,16）。从迭代过程来看，能发现一些问题：

扰动6小时以内的话，最佳的脉冲时间就在一天前6小时，在ATK上能看到，此时也是接近降交点的位置，变倾角非常有利，晚上可以在正式解上观察脉冲都被拿来干了啥；

2. 副星的趋势很明显，但是主星一直没有收敛，不知何故

筛了一些备选的根数，都是看4号目标和ship比较强的，在数据库里做了抽取，目前可以确定比较好的升交点赤经了，但是基本都集中在40°的轨道，显然还是倾角越低越好，当然这只是顺行，逆行还没有统计，结论应该不会差的太多。最终选定在弧度4.28和3.80的范围优先抽取（总量和ship都很不错）ship专用星，其他的则以目标4为基准（只用57°上下，不行就机动修，减少星数）

发现了约束问题，修改后发现效果变得不显著了。。。。重新从excel表格里挑根数

## 2024.11.16

随便挑了一些根数，目标4现在非常容易覆盖，但是其他的地面目标打配合暂时还有点难，这个或许要考虑用数据库搜索搜出比较好的构型了。

从数据库里筛选了看目标4最有利的，看总量最有利的以及看ship最有利的，或许需要考虑一下自学GA搜出好序列，或者暴力for（反正加起来也只有不到三百条数据）

数据库瞎挑了7颗星，机动压榨了一下，还是比较有效的，

其中ship的压榨效果更为显著，查了一下覆盖分析，上面是无机动的，下面是有机动的：

可以看到第二天的覆盖分布产生了很大的变化，

首先基于已有的结果可以达成一些共识：

1. 最高纬度的目标4最少需要3颗星，并且通常可以配合目标16一起观测；
2. 单次大机动对于压榨重访时间是很有效的，特别是第一天任务完成但是第二天没完成的，在树修好之前可以考虑先用大机动调整，因为轨道周期最多只有不到两小时，变轨频率可以非常高（每一圈升降交点都可以变轨）
3. 单次机动灵活性依然有限，机动前的任务是机动无法解决的，而且机动前的任务完成情况决定了后面压榨的上限，后期考虑改成多次机动（如果构型第一天完不成任务的话，可能需要3次以上机动，但是单颗星总和要保证小于1km/s）
4. ATK上的演示显示脉冲大部分用来变了倾角，如此看来变升交点赤经和变轨道高度都不是好主意，构型设计的重点要放在赤经的分布上，机动的作用就是变倾角，可以多次调整

### 明日讨论计划：

1. 最重要：确认树是继续修还是彻底放弃
2. 讨论一下大机动效果和构型之间的关系，以及机动次数如何设置
3. 给师兄看一下手动筛出来的三张根数表格，看看从里面还有没有关于构型的启示
4. 是否值得花点时间搞个构型搜索（目测自学GA等方法可能得花至少一个晚上）

## 2024.11.18

发现可见性列表有大问题，漏看会导致优化没法进行。机动反而得先搁置。

师弟们的满分结果，60s步长指标只能榨到85分，10s步长现在已经榨到98分。根据ATK的覆盖报告，我推测他们的覆盖算法虽然步长是60s，但识别方法绝对不是60s一格，这个只能请教他们的专业团队了。然而请教之后发现这个破解是没问题的，二分法查找当前也没有实现的必要，所以问题主要出在可见性判断上，卡在边界的点识别不了，可能默认地球是球体这个近似还是有影响的。。。

树的程序反而好修，主要是扩大扩展的容差然后验证可行性，预计今晚就改一版程序出来

## 2024.11.19

树程序已经修改完成，主要增设了：

1. 圆锥视场，增加过点的容差；
2. 打靶失败的情况下增加无机动打靶，确保每次都有点可扩展，退出只会因为没有可行解
3. Early stop修改：以时间最短的树为准生成可见列表，重访时间不符合要求则放弃

目前遇到的问题：用师弟们的构型做的验证，这个构型原本无机动状态下是无解的，而当前的状态是我们扩展出来的也是机动非常接近于0的情况，早停的时间和师弟们设置脉冲的位置也能对上。

目前需要先验证一件事情：一天之内能完成任务的TNC是否用树搜索是可扩展的：

- 如果是，那么就是TNC排序设计不合理，导致这个TNC被扔掉了，需要找个合理的排序方法，或者强行扩大规模，但是算力可能不够；
- 如果不是，那可能师弟们的构型并不适合树搜索，还是需要先找适合树工作的构型，数据库的筛选规则可能比较合适，暂时用无机动8颗的构型；
- 师弟们这个留给大机动程序验证

## 2024.11.20

发现树程序里的重要缺漏：没有完全复刻ATK的可见性列表，只复刻了打靶时刻，看来整个可见性列表都要改了

用无机动满分构型验证，发现满分的结果连几秒钟的覆盖范围都要贪....看来扩展列表的计算需要另想办法，目前的思路是尽量不要动节点的结构，在扩展TNC更新时刻表这一步进行，从tf开始，向前和向后各倒退5分钟（注意还得是60s的倍数，取余），另外就是可见列表的算法可能也需要更新。

进行了纯无机动的扩展，结果发现可见性列表生成没问题，但是树扩展不到底，应该是TNC的筛选出现了问题，核查了发现三百秒的点都能扩展，但是TNC不知道什么原因在筛选的过程中把可行的搞丢了。

## 2024.11.21

### 大机动优化：

验证了一下12构型的机动压榨，很快就到了100分，至少证明100分是有可能的，而且这个100分的覆盖质量大概率比之前无机动的高（因为我们的可见性列表收的比较紧）

发现师弟们的构型其实有一颗星是三个脉冲....最终榨到了98分，ship榨到了3.16h，应该是没法再榨了，这是构型的问题。

在原脉冲的基础上扰动了一下后四颗低纬星的RAAN，AP和TA，榨到了99分，争取今晚榨出一版可行解。

这里提示了我们一点，高纬度的构型最好不要改变，而且初步优化时，高纬度最好只负责好高纬度，找个三颗星/四颗星的好构型，将40度以上的目标全部负责好即可，师弟的构型已经证明了四颗星肯定是没问题的，三颗星应该加机动也可以；

其余目标交给40度以下的星负责，但是优化应该在已经选好的高纬度构型基础上做

## 2024.11.22

构型经过了压榨，最终达到了99.3548分，将脉冲策略和根数都压榨了几次，可以确认单机动情况下构型已经到头了。

问题在于ship最大重访时间是3.09h，大约5分钟，通过调整赤经和真近点角无法解决，原因是这个点对应的覆盖质量非常低，持续时间只有49s，略作调整就会变成不可见点。目前只能加入双机动优化了，但是有优化不动的风险。先跑着看看，但是可以肯定的是如果机动次数多一些一定是有解的，目前使用的机动是1126.3892m/s，距离师弟们的解还有整1km/s，有很大希望获得脉冲更小的可行解。

树程序已经和师兄讨论过，目前有一些尽可能将可行的TNC向前排的思路，主要要修改sortTNC，TNC遇到的问题：

1. 有些时间较长的点被扩展，影响了TNC排序算法对可行解的识别；
2. 最本质的问题：TNC每次扩展打靶时间无法控制，是否真的有可行解存在？

## 2024.11.24

重构了机动程序，主要目的：每颗星机动几次都可以变

## 2024.11.28

连续四五天都在做机动优化，发现了一个高分的大偏心率构型，无机动条件下，这个构型ship的重访时间会比师弟们的快一小时。或许后续可以考虑使用大偏心率轨道进一步提升分数。

目前正在用新的构型打断点进行机动优化，根据ATK的时刻表定锚点，每次机动不要求全程符合要求，只要在锚点之内满足即可，以此递推，直到完全满足为止。这样做一定能得到可行解，但不保证机动最优，因为目前采用了贪心策略，不能保证全局上最优，后期还要做局部优化。争取在周末之前拿出一版可行解。

目前可以确定机动有如下几个作用：

1. 无论何时都可以采用：调相，主要适用于差一点点就能看到的目标
2. 不太容易实现但比较必要：调赤经
3. 倾角变化的贡献不算非常大

地面构型仍然非常关键，先保证高纬度地面可全覆盖，再机动看ship和低纬度。目前将高纬度目标划为30°以上，对应高倾角构型，倾角设为55°。无机动状态下基本可以确定3颗星不可能覆盖所有点，所以直接筛选4颗星的构型。

1. 90°赤经差构型，二体轨道生成数据库，赤经范围0-90°，只给主星的根数，从星跟在后面

2. 偏心率统一用近地点250km，远地点950km的轨道

## 2024.11.29 重大突破：可行解生成，目前RANK 2！

### 可行解的生成策略：

总脉冲：3404m/s

构型：4个大偏心率轨道，4个高倾角小偏心率但不近圆轨道负责高纬度目标，不机动；4个低倾角大偏心率轨道负责低纬度目标+船，最多机动4次

机动设计方法：根据时间打点，只需要指定时间段内完成任务即可，然后保存之前的机动，直至任务全都完成。采用贪心方法，优化方法是每一段脉冲最小，但总体不一定最小

### 目前归纳的结论：

1. 无机动条件下：

   > 每个目标要观测，通常一圈只能看一次；
   >
   > 遇到纬度和倾角相近时，可以升交和降交各看一次，但是时间相距很近，对重访满足要求没有明显作用；
   >
   > 二体假设下，各个目标的观测区是固定的，因此下次再看一定是24h左右，所以想地面全覆盖，至少需要4颗星才能满足6小时的要求；
   >
   > 无机动轨道不可能一次性覆盖所有地面点，因此无机动至少需要8颗星才能全覆盖
   >
   > 椭圆轨道有利于降低周期，无观测任务时降低高度快速通过，观测区设在较高的位置

2. 有机动条件下：

   >最有效的机动方式是调周期，可以先在二体假设下设计调相的构型，重点在于给出脉冲的初值，之后再在J2摄动下增加赤经的调整；
   >
   >倾角最好不动，刻意设计倾角改变没有意义
   >
   >大偏心率（0.01-0.04）轨道在J2摄动下，12h的赤经退行即可达到3-4°，我们的最大接收量是6°，因此每隔12-16h就要调一次赤经；
   >
   >小偏心率（0.005以下）两天退行8°，一天调一次即可
   >
   >在近地点调相，有可能可以4颗星覆盖所有地面目标，4颗星的调相也是同步的，做好一颗星就能搞定剩下的

### 下一步的策略：

1. 构型：生成数据库转成二体的，分为大偏心率轨道和小偏心率轨道，目标是获取最好的RAAN、AP、TA组合。构型是四颗星打配合，但是数据库只列出第一颗星。这是为后面有针对性的机动设计做准备，暂时不急着出

倾角：统一采用55.6°

大偏心率形状：统一采用近地点220km，远地点980km

小偏心率形状：统一采用近地点600km，远地点980km

网格：RAAN、AP、TA

主星RAAN范围：0-90°，AP，TA范围0-360°

数据：主星根数 | 四星构型的高纬度点（40°以上的目标点）完成度 | 所有地面目标点的完成度

2. 机动：先从目前已经有的构型入手看可行度

- 优化目标：所有地面点的完成度 - 之前已完成的必须还能完成，原本未完成的按照之前生成可行解的机动策略进行，按照时间锚点进行优化。
- 已完成的地面点作为约束，加惩罚系数；未完成的对重访时间做优化，算分；ship暂时不管
- 先看看优化效果吧，好的话考虑做8颗以下的构型，目前来看时间锚点比较多，至少得锚四次

3. 树程序暂时弃疗，其实调相和树程序本质上是一样的，但是一定要在观测之后立刻机动吗？
4. 当前的满分方案：局部优化，降低脉冲

## 2024.11.30

初次尝试了一下四颗星全机动覆盖地面，打点很不顺利，第一个6小时都优化不到，而且机动已经非常大，构型必须重新设计。

问题：一定要4颗星覆盖所有地面点吗？加机动是否可以减轻未完成的3个点以及ship的观测压力？

## 2024.12.3

### 机动优化流水线：4颗星可接受，8颗星优化不下去

修改了打断点机动优化的程序，目前正在验证自动化流程的第一步，但是发现8颗星效果不好，全局优化极难收敛，但是换成4颗星效果就又变好了。目前来看可能的原因有如下两条：

1. 8颗星变量翻倍，解空间太大，但是本人不太认可这个原因，因为种群数翻倍效果依然很差；
2. 主要负责观测地面点的4颗星已经有比较高的观测得分了，机动扰动大部分情况下只会让分数变低，而且更容易违反约束。

改回了4颗星，目前第一个断点过了，正在进行第二个断点的验证，但是目前来看之前第二个断点的时间间隔比较短，极有可能是过不了的，这次流水线跑完考虑换成6-7个小时打一次断点。

### 树程序：打靶函数经过验证发现有问题

对所有地面目标进行了验证，发现只有无机动的目标可以扩展成功，没有一个脉冲是大于1m/s的，说明nlopt优化的目标函数有问题，应该检查一下大机动的点打靶打不出来的原因。

## 2024.12.15

这周主要在准备两个大作业，进度比较少。

### 机动优化：

二体递推的时刻表差别很大，可能暂时加不了速

随机种子：尝试修改random_threads，固定了整数和实数的两个种子，结果直接不优化了，目前只固定了实数的种子，但是优化过程并没有被复刻，得请教一下随机种子的具体作用

获取可行解：多次尝试之后，重点还是应该放在断点的设计上

- 第一个和第二个断点都很容易复现，只是脉冲大小每次各不相同；
- 第三个断点多次实验之后优化结果趋同，都是最大重访4小时，可以判定是断点本身不可行。

第一个断点是根据ATK的可见性报告选择的，目前正在尝试根据时刻表自适应调整断点间隔。

### 树程序

Obs_shooting修好了，接下来就是启发函数的设计了。
